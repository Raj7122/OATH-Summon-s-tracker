# CLAUDE.md - AI Assistant Guide for NYC OATH Summons Tracker

## Project Overview

**NYC OATH Summons Tracker** is a private, automated web application for the Law Office of Arthur L. Miller. It replaces the firm's manual process of downloading and filtering public spreadsheets by automatically finding, tracking, and persisting all NYC OATH summonses (specifically "IDLING" violations) relevant to the firm's clients.

**⚠️ IMPORTANT**: This document should always be read **in conjunction with TRD.md**, which contains the complete technical requirements, functional specifications, and acceptance criteria.

## Repository Status

**Current State**: Active Development
**Target MVP Date**: December 18, 2025
**Branch**: `claude/claude-md-mi3evgzx8kxx47cp-01DPRcGMm8KiUgKXP1LJVhFK`

## Tech Stack (MANDATORY)

### Frontend
- **Framework**: React 18+ with Vite
- **UI Library**: Material UI (MUI) v5+
  - `@mui/material`
  - `@mui/x-data-grid` (for main dashboard table)
  - `@mui/x-date-pickers` (for evidence tracking dates)
  - `@mui/icons-material`
- **Styling**: `@emotion/react`, `@emotion/styled`
- **Routing**: React Router v6+
- **State Management**: React Context API + `useState` (NO Redux, Zustand, or MobX)
- **Data Fetching**: AWS Amplify DataStore or React Query

### Backend (AWS Amplify)
- **Authentication**: Amazon Cognito
- **Database**: Amazon DynamoDB (via Amplify DataStore)
- **API**: AWS AppSync (GraphQL)
- **Functions**: AWS Lambda
- **Scheduling**: Amazon EventBridge Scheduler
- **Hosting**: AWS Amplify Hosting

### External Services
- **NYC Open Data API**: OATH Hearings Division Case Status
- **NYC PDF Service**: OATH Summons PDFs
- **NYC Video Service**: Idling Complaints Video Evidence
- **AI/OCR**: Google Gemini API (`gemini-2.5-flash`) - **NOT OpenAI or Claude**

## Project Structure

```
/
├── amplify/
│   ├── backend/
│   │   ├── api/
│   │   │   └── schema.graphql        # GraphQL schema (see TRD Section 4)
│   │   ├── auth/                     # Cognito configuration
│   │   └── function/
│   │       ├── dailySweep/           # FR-03: Daily data sweep Lambda
│   │       └── dataExtractor/        # FR-09: OCR & scraper Lambda
│   └── team-provider-info.json
├── src/
│   ├── pages/
│   │   ├── Login.tsx                 # FR-01: User authentication
│   │   ├── Dashboard.tsx             # FR-04: Main summons dashboard
│   │   ├── Clients.tsx               # FR-02: Client management CRUD
│   │   └── Account.tsx               # User account settings
│   ├── components/
│   │   ├── Layout.tsx                # App shell with header/nav
│   │   ├── Header.tsx                # Top navigation bar
│   │   ├── SummonsTable.tsx          # MUI DataGrid for summons
│   │   └── ClientForm.tsx            # Client add/edit form
│   ├── lib/
│   │   └── amplifyClient.ts          # Amplify initialization
│   ├── contexts/
│   │   └── AuthContext.tsx           # Auth state management
│   ├── models/                       # Auto-generated by Amplify
│   ├── theme.ts                      # MUI theme configuration
│   ├── App.tsx
│   └── main.tsx
├── public/
├── tests/                            # Unit tests (Jest/Vitest)
├── .env.example                      # Environment variable template
├── package.json
├── tsconfig.json
├── vite.config.ts
├── TRD.md                            # Complete technical requirements
├── CLAUDE.md                         # This file
└── README.md                         # Setup and deployment instructions
```

## Data Models (GraphQL Schema)

**⚠️ CRITICAL**: The complete schema is in **TRD.md Section 4**. Key points:

### Client Model
```graphql
type Client @model @auth(rules: [{ allow: owner }]) {
  id: ID!
  name: String!
  akas: [String]
  contact_name: String
  contact_address: String
  contact_phone1: String
  contact_email1: String
  contact_phone2: String
  contact_email2: String
  summonses: [Summons] @hasMany(indexName: "byClient", fields: ["id"])
}
```

### Summons Model
```graphql
type Summons @model @auth(rules: [{ allow: owner }]) {
  id: ID!
  clientID: ID! @index(name: "byClient", sortKeyFields: ["hearing_date"])

  # Core API Fields (from NYC Open Data)
  summons_number: String!
  respondent_name: String
  hearing_date: AWSDateTime
  status: String
  license_plate: String
  base_fine: Float
  amount_due: Float
  violation_date: AWSDateTime
  violation_location: String

  # Generated Links
  summons_pdf_link: AWSURL
  video_link: AWSURL

  # Scraper Fields (from FR-09)
  video_created_date: AWSDateTime
  lag_days: Int

  # User-Input Fields (FR-05, FR-06, FR-07)
  notes: String
  added_to_calendar: Boolean
  evidence_reviewed: Boolean
  evidence_requested: Boolean
  evidence_requested_date: AWSDateTime
  evidence_received: Boolean

  # OCR Fields (from Google Gemini)
  license_plate_ocr: String
  dep_id: String
  vehicle_type_ocr: String
  prior_offense_status: String
  violation_narrative: String
  idling_duration_ocr: String
  critical_flags_ocr: [String]
  name_on_summons_ocr: String
}
```

**⚠️ SECURITY CRITICAL**: The `@auth(rules: [{ allow: owner }])` directive is MANDATORY on both types. This ensures user isolation (User A cannot see User B's data).

## Critical Coding Rules (MUST FOLLOW)

These rules are from **TRD.md Section 18** and are MANDATORY:

### 1. Error Handling & Logging
- **All Lambda functions** must wrap logic in `try/catch` blocks
- Use `console.error()` for all errors (logs to CloudWatch)
- Return structured JSON error responses
- Log critical errors during:
  - API failures in `daily-sweep`
  - DB insert/update failures
  - OCR failures in `data-extractor`
  - Web scraping failures

### 2. State Management
- **Global State**: React Context API ONLY (for authenticated user)
- **Local State**: `useState` hook ONLY
- **FORBIDDEN**: Redux, Zustand, MobX

### 3. Async-First Performance
- All I/O operations MUST use `async/await`
- API calls to NYC Open Data, Google Gemini, Amplify DataStore must be non-blocking
- Use Promise.all() for parallel operations where appropriate

### 4. Testing Requirements
- **Unit tests** required for Lambda function business logic (Jest/Vitest)
- Mock all external API calls
- Test client-matching logic in `daily-sweep`
- Test HTML scraping and OCR extraction in `data-extractor`

### 5. Input Validation
- All user-facing forms must use MUI's built-in validation
- Required fields: `required` prop
- Email fields: `type='email'`
- Client form must validate all 8 contact fields

### 6. Code Comments
- Add inline comments (`// comment`) for complex business logic
- **REQUIRED** for:
  - Client-matching logic in `daily-sweep`
  - HTML scraping selectors in `data-extractor`
  - Any regex or string manipulation

## Development Workflow

### Git Workflow

1. **Commit Messages**: Use conventional commits
   - `feat(clients): add contact fields to client form`
   - `fix(sweep): handle null respondent names`
   - `chore(deps): upgrade MUI to v5.14`

2. **Pull Requests**:
   - Always create PRs for merging to `main`
   - Reference TRD functional requirements (e.g., "Implements FR-03")
   - Ensure all acceptance criteria pass (TRD Section 15)

### Code Quality

- **Linting**: ESLint with TypeScript rules
- **Type Safety**: Strict TypeScript mode
- **Testing**: >80% coverage for Lambda functions
- **Documentation**: Comment complex logic, keep README updated

## Functional Requirements (Quick Reference)

See **TRD.md Section 3** for complete details:

- **FR-01**: User Authentication (Cognito + protected routes)
- **FR-02**: Client Management CRUD (with contact fields)
- **FR-03**: Automated Daily Data Sweep (Lambda + EventBridge)
- **FR-04**: Main Summons Dashboard (MUI DataGrid)
- **FR-05**: Evidence Tracking (checkboxes + date picker)
- **FR-06**: Notes Field (multiline text)
- **FR-07**: Manual Calendar Handoff (checkbox)
- **FR-08**: CSV Export (MUI DataGrid built-in)
- **FR-09**: Automated Data Extraction (Gemini OCR + cheerio scraper)

## Environment Variables

```bash
# Frontend (public, auto-generated by Amplify)
VITE_AMPLIFY_CONFIG_...

# Backend Lambda Functions (secrets, configured in AWS Console)
NYC_OPEN_DATA_APP_TOKEN=<your-app-token>
GEMINI_API_KEY=<your-api-key>
```

Create a `.env.example` file with placeholder values.

## External APIs

### 1. NYC Open Data (OATH Hearings)
- **URL**: `https://data.cityofnewyork.us/resource/jz4z-kudi.json`
- **Auth**: App Token header
- **Query Params**: `$limit=5000`, `code_description=IDLING`, `$order=hearing_date DESC`

### 2. NYC Summons PDF
- **URL**: `https://a820-ecbticketfinder.nyc.gov/GetViolationImage?violationNumber={summons_number}`
- **Auth**: None

### 3. NYC Idling Video
- **URL**: `https://nycidling.azurewebsites.net/idlingevidence/video/{summons_number}`
- **Auth**: None
- **Use**: Scrape "Video Created Date" with cheerio

### 4. Google Gemini API
- **Model**: `gemini-2.5-flash`
- **Auth**: API Key
- **Use**: Extract structured JSON from PDF buffer (see FR-09 prompt in TRD)

## Constraints (DO NOT DO)

From **TRD.md Section 17** - these are FORBIDDEN:

- ❌ **NO** file upload system
- ❌ **NO** invoicing/billing features
- ❌ **NO** automated calendar integration
- ❌ **NO** automated email/reminder system
- ❌ **NO** Supabase or Firebase (must use AWS Amplify)
- ❌ **NO** OpenAI or Claude for OCR (must use Google Gemini)
- ❌ **NO** frontend-heavy logic (use Lambda for sweep/extraction)
- ❌ **NO** headless browser for scraping (must use cheerio)

## AI Assistant Guidelines

### When Starting a Task

1. **Read TRD.md First**: Always consult the TRD for functional requirements
2. **Use TodoWrite**: Track multi-step tasks with clear todos
3. **Check Constraints**: Verify task doesn't violate Section 17 constraints
4. **Follow Tech Stack**: Only use approved libraries and services

### When Writing Code

1. **Frontend (React/MUI)**:
   - Use functional components with hooks
   - Use MUI components exclusively (no custom CSS frameworks)
   - Implement DataGrid with all required columns (FR-04)
   - Use DatePicker from `@mui/x-date-pickers`
   - Handle auth with AuthContext

2. **Backend (Lambda Functions)**:
   - Wrap all logic in `try/catch`
   - Log errors with `console.error()`
   - Use `async/await` for all I/O
   - Comment complex logic (required)
   - Mock external APIs in tests

3. **GraphQL Schema**:
   - Always include `@auth(rules: [{ allow: owner }])`
   - Use proper indexes (`@index`, `@hasMany`, `@belongsTo`)
   - Match field types to TRD Section 4 exactly

### When Testing

1. **Unit Tests** (Lambda functions):
   - Test client-matching logic (FR-03)
   - Test HTML parsing (FR-09)
   - Mock all external APIs
   - Use Jest or Vitest

2. **Manual Testing** (Acceptance Criteria):
   - Follow TRD Section 15 checklist
   - Test user isolation (User A vs User B)
   - Test mobile responsiveness
   - Test CSV export

### Common Tasks

#### Adding a New Feature
1. Find the FR-## in TRD.md
2. Create TodoWrite list for implementation
3. Write code following tech stack rules
4. Add tests
5. Update README if needed
6. Commit with `feat(scope): description`

#### Fixing a Bug
1. Reproduce the bug
2. Check if it violates an NFR (TRD Section 9)
3. Write a failing test
4. Fix with proper error handling
5. Verify test passes
6. Commit with `fix(scope): description`

## Security Considerations

- **Auth**: All routes protected except `/login`
- **Data Isolation**: Enforced by `@auth(rules: [{ allow: owner }])`
- **Secrets**: Environment variables only (never commit `GEMINI_API_KEY` or `NYC_OPEN_DATA_APP_TOKEN`)
- **Input Validation**: MUI validation on all forms
- **XSS Prevention**: MUI components handle escaping

## Performance Requirements

From **TRD.md Section 9**:

- Dashboard load (cold): < 5 seconds
- Table interactions (sort/filter): < 500ms
- OCR/Scrape function: < 60 seconds (async)

## Deployment

1. **Frontend & Backend**: Deploy to AWS Amplify Hosting
2. **CI/CD**: Connect to GitHub repo, auto-deploy on `main` branch
3. **Cron Job**: Configure EventBridge to trigger `daily-sweep` Lambda daily
4. **Environment**: Set `NYC_OPEN_DATA_APP_TOKEN` and `GEMINI_API_KEY` in AWS Console

## Acceptance Criteria Checklist

Before marking work as complete, verify all criteria from **TRD.md Section 15**:

- [ ] User can sign up, log in, access dashboard
- [ ] User can CRUD clients
- [ ] `daily-sweep` runs and pulls NYC API data
- [ ] Matching summons appear in dashboard
- [ ] Non-matching summons don't appear
- [ ] Evidence checkboxes persist on reload
- [ ] Notes field persists on reload
- [ ] CSV export downloads
- [ ] User A cannot see User B's data
- [ ] App is usable on mobile
- [ ] `data-extractor` triggers after new summons
- [ ] `video_created_date` populates from scraper
- [ ] At least one OCR field populates from Gemini

## Glossary (Domain Terms)

- **OATH**: Office of Administrative Trials and Hearings (NYC agency)
- **Summons**: A ticket or violation (legal document)
- **Respondent**: The entity (company) receiving the summons
- **AKA**: "Also Known As" - company alias (e.g., "GC Warehouse" vs "G.C. Whse")
- **Sweep**: The automated process of checking the NYC Open Data API
- **Idling**: The specific violation type this system tracks
- **Pity**: NOT applicable (this is NOT a gacha game - that was the initial misunderstanding)

## Deliverables

From **TRD.md Section 16**, the coding agent must output:

1. Complete React (Vite) + MUI frontend codebase
2. AWS Amplify backend function code (`daily-sweep`, `data-extractor`)
3. `schema.graphql` file (from TRD Section 4)
4. `README.md` with Amplify CLI setup instructions
5. `.env.example` file

## Changelog

### 2025-11-17
- Updated CLAUDE.md to reflect actual TRD requirements
- Corrected project description (NYC legal summons, not gacha game)
- Added mandatory tech stack (React + Vite + MUI + AWS Amplify)
- Documented critical coding rules from TRD Section 18
- Added data models, constraints, and acceptance criteria

---

## Notes for AI Assistants

- **ALWAYS** read TRD.md for complete requirements
- This is a legal case management system, not a game tracker
- The client is a law office with 3 users (Arthur, Jackie, Jelly)
- MVP deadline is December 18, 2025
- Security (user isolation) is CRITICAL
- AWS Amplify is MANDATORY (no Supabase/Firebase)
- Google Gemini is MANDATORY for OCR (no OpenAI/Claude)
- Follow TRD Section 18 critical coding rules exactly
- When in doubt, ask the user or consult the TRD

---

*This document is a companion to TRD.md. When there is a conflict, TRD.md takes precedence.*
