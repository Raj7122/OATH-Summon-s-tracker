# NYC OATH Summons Tracker - GraphQL Schema
# This schema defines the data models for AWS Amplify (DynamoDB + AppSync)

type Client @model @auth(rules: [{ allow: private }]) {
  id: ID!
  name: String!
  akas: [String]
  contact_name: String
  contact_address: String
  contact_phone1: String
  contact_email1: String
  contact_phone2: String
  contact_email2: String
  summonses: [Summons] @hasMany(indexName: "byClient", fields: ["id"])
}

type Summons @model @auth(rules: [{ allow: private }]) {
  id: ID!
  clientID: ID! @index(name: "byClient", sortKeyFields: ["hearing_date"])
  client: Client @belongsTo(fields: ["clientID"])

  # Core API Fields (from NYC Open Data)
  summons_number: String! @index(name: "bySummonsNumber", queryField: "summonsBySummonsNumber")
  respondent_name: String

  # Hearing Information
  hearing_date: AWSDateTime
  hearing_time: String
  hearing_result: String
  status: String

  # Violation Information
  code_description: String
  violation_date: AWSDateTime
  violation_time: String
  violation_location: String
  license_plate: String

  # Financial Information
  base_fine: Float
  amount_due: Float
  paid_amount: Float
  penalty_imposed: Float

  # Generated Links
  summons_pdf_link: AWSURL
  video_link: AWSURL

  # Scraper Fields (from FR-09)
  video_created_date: AWSDateTime
  lag_days: Int

  # User-Input Fields (FR-05, FR-06, FR-07, TRD v1.8)
  notes: String  # Legacy field - kept for backward compatibility
  # Threaded comments with attribution (replaces simple notes field)
  # Structure: [{ id, text, by, userId, date }]
  notes_comments: AWSJSON
  added_to_calendar: Boolean @default(value: "false")
  evidence_reviewed: Boolean @default(value: "false")
  evidence_requested: Boolean @default(value: "false")
  evidence_requested_date: AWSDateTime
  evidence_received: Boolean @default(value: "false")
  evidence_received_date: AWSDateTime

  # File attachments stored as AWSJSON array
  # Structure: [{ id, key, type, name, uploadedBy, uploadedById, uploadedAt, size }]
  attachments: AWSJSON

  # TRD v1.8: Client Feedback Updates
  internal_status: String @default(value: "New")
  # Internal status with attribution (who changed it and when)
  # Structure: { value: string, by: string, userId: string, date: string }
  internal_status_attr: AWSJSON
  offense_level: String
  agency_id_number: String

  # Change Tracking (for UPDATED badge transparency)
  last_change_summary: String
  last_change_at: AWSDateTime

  # OCR Fields (from Google Gemini)
  # id_number: The DEP complaint ID number in format YYYY-NNNNNN (e.g., 2025-030846)
  # This is NOT the summons number - renamed from dep_id for clarity
  id_number: String
  license_plate_ocr: String
  vehicle_type_ocr: String
  prior_offense_status: String
  violation_narrative: String
  idling_duration_ocr: String
  critical_flags_ocr: [String]
  name_on_summons_ocr: String

  # OCR Processing Status (for Priority Queue Strategy)
  # ocr_status: 'pending' = needs OCR, 'complete' = successfully OCR'd, 'failed' = OCR attempted but failed
  ocr_status: String @default(value: "pending") @index(name: "byOcrStatus", queryField: "summonsByOcrStatus")
  last_scan_date: AWSDateTime
  ocr_failure_count: Int @default(value: "0")
  ocr_failure_reason: String

  # Sync Tracking ("Proof of Life" for Arthur)
  # last_metadata_sync: Updated every time Phase 1 sees this record from the API
  # This proves the system is working even if no changes occurred
  last_metadata_sync: AWSDateTime

  # Ghost Detection (for records that disappear from API)
  api_miss_count: Int @default(value: "0")
  is_archived: Boolean @default(value: "false")
  archived_at: AWSDateTime
  archived_reason: String

  # Invoice Tracking
  is_invoiced: Boolean @default(value: "false")
  invoice_date: AWSDateTime

  # Activity Log (Summons Lifecycle Audit)
  # Stores history of all changes detected during daily sweeps
  # Structure: [{ date, type, description, old_value, new_value }]
  # Types: CREATED, STATUS_CHANGE, RESCHEDULE, AMOUNT_CHANGE, RESULT_CHANGE, AMENDMENT, OCR_COMPLETE, ARCHIVED
  activity_log: AWSJSON
}

# SyncStatus - Global sync health tracking (singleton record)
# Provides "Proof of Life" data for the frontend header badge
type SyncStatus @model @auth(rules: [{ allow: private }]) {
  id: ID!  # Always "GLOBAL" for singleton pattern

  # Overall Sync Status
  last_successful_sync: AWSDateTime
  last_sync_attempt: AWSDateTime
  sync_in_progress: Boolean @default(value: "false")

  # Phase 1 Results (Metadata Sweep)
  phase1_status: String  # 'success' | 'partial' | 'failed'
  phase1_completed_at: AWSDateTime
  phase1_new_records: Int
  phase1_updated_records: Int
  phase1_unchanged_records: Int
  phase1_errors: [String]

  # Phase 2 Results (OCR Processing)
  phase2_status: String  # 'success' | 'partial' | 'failed'
  phase2_completed_at: AWSDateTime
  phase2_ocr_processed: Int
  phase2_ocr_remaining: Int
  phase2_ocr_failed: Int

  # Daily OCR Counter (resets each day)
  ocr_processed_today: Int @default(value: "0")
  ocr_processing_date: AWSDate  # Reset counter when this date changes

  # API Health Check
  oath_api_reachable: Boolean @default(value: "true")
  oath_api_last_check: AWSDateTime
  oath_api_error: String
}
